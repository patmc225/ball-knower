rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for security
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isValidUsername(username) {
      return username is string 
        && username.size() >= 3 
        && username.size() <= 30;
    }
    
    function isValidEloRating(rating) {
      return rating is list
        && rating.size() > 0
        && rating.size() <= 1000; // Limit history to 1000 ratings
    }
    
    // Rate limiting helper - check if user hasn't exceeded daily limits
    function withinRateLimit() {
      // Users can only create/update 100 documents per day
      return request.time < request.resource.data.lastUpdate + duration.value(1, 's')
        || request.time > request.resource.data.dailyLimitReset;
    }
    
    // Users collection - user profiles and stats
    match /users/{userId} {
      // Anyone can read user profiles (for leaderboards, matchmaking)
      allow read: if true;
      
      // Users can only create their own profile
      allow create: if isSignedIn() 
        && isOwner(userId)
        && isValidUsername(request.resource.data.displayName)
        && request.resource.data.stats.gamesPlayed == 0
        && request.resource.data.stats.wins == 0
        && request.resource.data.stats.losses == 0;
      
      // Users can only update their own profile
      allow update: if isSignedIn() 
        && isOwner(userId)
        && (
          // Allow username changes if valid
          !('displayName' in request.resource.data.diff(resource.data).affectedKeys())
          || isValidUsername(request.resource.data.displayName)
        )
        && (
          // Ensure ELO rating array doesn't grow too large
          !('stats' in request.resource.data.diff(resource.data).affectedKeys())
          || !('eloRating' in request.resource.data.stats)
          || isValidEloRating(request.resource.data.stats.eloRating)
        )
        && (
          // Prevent stats manipulation - wins/losses can only increase
          !('stats' in request.resource.data.diff(resource.data).affectedKeys())
          || (
            request.resource.data.stats.gamesPlayed >= resource.data.stats.gamesPlayed
            && request.resource.data.stats.wins >= resource.data.stats.wins
            && request.resource.data.stats.losses >= resource.data.stats.losses
          )
        );
      
      // Users cannot delete their profile
      allow delete: if false;
    }
    
    // Daily challenges collection
    match /daily/{date} {
      // Anyone can read daily challenges
      allow read: if true;
      
      // Only admins can write (via Firebase Admin SDK with service account)
      allow write: if false;
    }
    
    // User daily challenge completions
    match /userDailyChallenges/{userId} {
      // Users can only read their own challenge history
      allow read: if isSignedIn() && isOwner(userId);
      
      // Users can create/update their own challenge completions
      // But prevent cheating by limiting updates per day
      allow create, update: if isSignedIn() 
        && isOwner(userId)
        && request.resource.data.size() <= 1000; // Limit to 1000 daily completions stored
      
      // Users cannot delete their challenge history
      allow delete: if false;
      
      // Sub-collection for individual challenge completions
      match /completions/{challengeDate} {
        allow read: if isSignedIn() && isOwner(userId);
        
        // Users can only record one completion per challenge date
        allow create: if isSignedIn() 
          && isOwner(userId)
          && !exists(/databases/$(database)/documents/userDailyChallenges/$(userId)/completions/$(challengeDate));
        
        // No updates or deletes allowed (completion is final)
        allow update, delete: if false;
      }
    }
    
    // Leaderboard collection (optional - if you add one)
    match /leaderboard/{document=**} {
      // Anyone can read leaderboard
      allow read: if true;
      
      // Only backend can write to leaderboard
      allow write: if false;
    }
    
    // Games collection (for online multiplayer if implemented)
    match /games/{gameId} {
      // Players in the game can read it
      allow read: if isSignedIn();
      
      // Any signed-in user can create a game
      allow create: if isSignedIn()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.status == 'waiting';
      
      // Only players in the game can update it
      allow update: if isSignedIn()
        && (
          request.auth.uid in resource.data.players
          || request.auth.uid == resource.data.createdBy
        )
        && (
          // Ensure game state transitions are valid
          resource.data.status == 'waiting' && request.resource.data.status in ['active', 'cancelled']
          || resource.data.status == 'active' && request.resource.data.status in ['active', 'completed']
        );
      
      // Games can only be deleted by creator if not started
      allow delete: if isSignedIn()
        && request.auth.uid == resource.data.createdBy
        && resource.data.status == 'waiting';
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
